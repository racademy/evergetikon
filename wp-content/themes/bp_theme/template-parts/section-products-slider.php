<?php
$title = get_field('section_title');
$link = get_field('section_link');
$product_source = get_field('product_source');
$manual_products = get_field('manual_products');
$category_id = get_field('product_category');

$products = [];

if ($product_source === 'manual' && $manual_products) {
    $products = $manual_products;
} elseif ($product_source === 'category' && $category_id) {
    $query = new WP_Query([
        'post_type' => 'product',
        'posts_per_page' => 10,
        'tax_query' => [
            [
                'taxonomy' => 'product_cat',
                'field' => 'term_id',
                'terms' => $category_id,
            ]
        ],
    ]);
    $products = $query->have_posts() ? $query->posts : [];
}

if (!$products)
    return;
?>

<section class="section-products-side-img">
    <div class="container">
        <div class="section-products-side-img__wrapper">
            <div class="slider-container-second splide" aria-label="Product Slider">
                <?php if ($title || $link): ?>
                    <div class="section-header">
                        <?php if ($title): ?>
                            <h2><?= esc_html($title); ?></h2>
                        <?php endif; ?>
                        <?php if ($link): ?>
                            <div class="theme-buttons">
                                <a href="<?= esc_url($link['url']); ?>" target="<?= esc_attr($link['target'] ?: '_self'); ?>"
                                    class="theme-buttons__neutral"><?= esc_html($link['title']); ?></a>
                            </div>
                        <?php endif; ?>
                    </div>
                <?php endif; ?>

                <div class="splide__track">
                    <ul class="splide__list">
                        <?php foreach ($products as $product):
                            $product_id = is_object($product) ? $product->ID : $product;
                            $product_obj = wc_get_product($product_id);
                            if (!$product_obj)
                                continue;

                            $thumbnail = get_the_post_thumbnail_url($product_id, 'medium');
                            $product_title = get_the_title($product_id);
                            $product_link = get_permalink($product_id);
                            $extra = get_field('extra_product_tag', $product_id);
                            $price_html = $product_obj->get_price_html();
                            ?>
                            <li class="splide__slide">
                                <div class="product-card">
                                    <?php if (is_product_new($product_id, 14)): ?>
                                        <span class="badge-new caption_m"><?= esc_attr_e('New', 'bp_theme') ?></span>
                                    <?php endif; ?>

                                    <?php if (function_exists('YITH_WCWL')): ?>
                                        <div class="yith-wcwl-add-button">
                                            <?= do_shortcode('[yith_wcwl_add_to_wishlist product_id="' . esc_attr($product_id) . '"]'); ?>
                                        </div>
                                    <?php endif; ?>

                                    <a class="product-card__content" href="<?= esc_url($product_link); ?>">
                                        <?php if ($thumbnail): ?>
                                            <div class="product-card__image-wrapper">
                                                <img src="<?= esc_url($thumbnail); ?>" alt="<?= esc_attr($product_title); ?>">
                                            </div>
                                        <?php else: ?>
                                            <div class="product-card__image-wrapper">
                                                <img src="/wp-content/uploads/woocommerce-placeholder.png" alt="Default image">
                                            </div>
                                        <?php endif; ?>
                                        <div class="caption_s"><?= esc_html($extra); ?></div>
                                        <div class="body_one_regular"><?= esc_html($product_title); ?></div>
                                        <?php if ($price_html): ?>
                                            <div class="body_one_semibold"><?= $price_html; ?></div>
                                        <?php endif; ?>
                                    </a>

                                    <?php if ($product_obj->is_purchasable() && $product_obj->is_in_stock()): ?>
                                        <div class="theme-buttons">
                                            <a href="?add-to-cart=<?= esc_attr($product_id); ?>" data-quantity="1"
                                                data-product_id="<?= esc_attr($product_id); ?>"
                                                data-product_sku="<?= esc_attr($product_obj->get_sku()); ?>"
                                                class="theme-buttons__neutral ajax_add_to_cart add_to_cart_button"
                                                rel="nofollow">
                                                <?= esc_attr_e('ADD TO CART', 'bp_theme') ?>
                                            </a>
                                        </div>
                                    <?php endif; ?>
                                </div>
                            </li>
                        <?php endforeach; ?>
                    </ul>
                </div>
            </div>
        </div>
    </div>
    <svg class="bg-element-slider" width="339" height="434" viewBox="0 0 339 434" fill="none"
        xmlns="http://www.w3.org/2000/svg">
        <path
            d="M199.375 375.665C208.334 364.545 216.104 352.255 220.728 338.684C222.96 332.138 224.481 325.351 225.17 318.47C225.944 310.669 225.566 302.869 224.734 295.09C222.89 277.873 219.021 260.955 217.028 243.759C216.217 236.805 215.943 229.814 215.309 222.842C214.708 216.256 214.028 209.676 213.586 203.078C213.083 195.554 212.809 187.973 213.474 180.446C214.025 174.174 215.113 167.457 218.497 162.012C218.61 161.83 218.692 161.644 218.741 161.464C221.99 158.801 225.301 156.205 228.648 153.664C238.369 146.29 248.419 139.36 258.374 132.314C265.09 127.56 271.781 122.794 277.883 117.316C270.47 129.365 262.727 141.271 257.134 154.178C254.235 160.859 251.927 167.825 250.571 174.99C249.059 182.979 248.842 191.214 249.327 199.313C250.366 216.673 255.043 233.506 258.813 250.403C259.938 255.443 260.968 260.477 262.855 265.307C264.535 269.601 266.772 273.707 269.571 277.38C275.344 284.961 283.248 290.385 291.414 295.117C292.71 295.866 294.368 294.436 294.161 293.081C294.021 292.162 293.868 291.249 293.713 290.333C294.28 290.251 294.795 289.883 295.042 289.143C299.687 275.289 300.522 260.626 303.052 246.328C305.54 232.273 309.118 218.377 310.307 204.118C310.835 197.797 310.938 191.418 310.134 185.115C309.417 179.497 308.119 173.961 306.582 168.51C303.418 157.271 299.154 146.375 295.923 135.157C293.066 125.22 291.073 114.842 292.097 104.549C292.585 102.805 293.076 101.067 293.588 99.3355C293.691 98.9825 293.801 98.6264 293.905 98.2734C295.941 94.9834 297.776 91.5595 299.404 88.0322C300.062 86.6078 300.678 85.1652 301.266 83.7135C306.671 93.4921 319.397 99.0586 330.407 98.109C331.282 101.603 332.779 104.923 334.87 108.116C339.604 115.356 345.853 121.458 351.334 128.117C355.952 133.726 360.921 139.065 366.328 143.931C371.815 148.868 377.786 153.335 384.346 156.756C390.351 159.885 396.902 161.394 403.31 163.452C411.278 166.005 419.194 168.726 427.278 170.893C434.838 172.923 442.675 174.554 450.545 174.183C452.03 174.113 452.834 172.165 451.92 171.039C447.186 165.196 442.437 159.364 437.136 154.017C431.826 148.658 425.928 144.044 419.456 140.169C406.867 132.637 393.22 126.924 381.1 118.607C375.263 114.598 369.724 109.975 365.423 104.318C363.923 102.339 362.573 100.264 361.335 98.1182C368.861 99.0068 376.418 99.6521 384.002 99.6308C392.214 99.6064 400.38 98.669 408.409 96.9556C418.292 94.8404 428.006 91.8121 437.535 88.4735C447.674 84.9218 457.623 80.8101 467.225 75.9923C470.133 74.5345 473.011 73.0067 475.846 71.4211C483.957 67.5863 491.831 62.9572 498.317 56.779C500.107 55.0777 498.046 52.0191 495.955 53.6017C488.953 58.9094 481.583 63.6694 473.941 67.9454C473.529 68.1402 473.114 68.335 472.703 68.5267C463.906 72.5806 454.727 75.7914 445.442 78.5184C436.261 81.2118 426.955 83.4518 417.487 84.867C408.028 86.2792 398.475 86.9 388.916 87.04C377.857 87.2013 366.804 86.7722 355.754 86.4739C355.711 86.3735 355.668 86.2731 355.626 86.1696C352.882 79.4162 350.63 72.4771 348.359 65.5563C346.225 59.0403 343.734 52.6582 341.576 46.1574C336.842 31.9049 335.943 16.8186 339.354 2.17046C339.933 -0.312996 336.007 -0.876023 335.434 1.59221C334.008 7.7065 333.325 13.909 333.331 20.1085C333.172 18.669 333.005 17.2294 332.825 15.7929C332.749 15.1751 332.453 14.7338 332.057 14.4599C332.102 14.3229 332.151 14.189 332.194 14.0521C332.956 11.6508 329.316 10.0652 328.548 12.4999C328.508 12.6217 328.466 12.7343 328.429 12.853C327.698 12.8104 326.954 13.136 326.548 13.9821C323.348 20.6898 320.22 27.4341 317.184 34.221C316.684 34.9879 316.184 35.7519 315.684 36.5158C313.142 40.4083 310.612 44.3131 308.317 48.3578C305.951 52.5304 304.046 56.8734 302.275 61.3229C301.873 62.3333 301.48 63.3498 301.089 64.3633C292.009 66.0342 283.08 68.5145 274.225 71.0832C264.102 74.0201 253.933 76.8688 243.953 80.2714C223.353 87.2865 203.237 96.1277 184.497 107.209C165.778 118.275 150.262 133.367 138.34 151.522C135.402 155.998 132.674 160.612 130.134 165.324C128.004 169.274 126.159 173.373 123.992 177.306C120.535 183.572 116.448 189.47 112.723 195.575C112.576 195.816 112.427 196.062 112.281 196.309C109.757 196.26 107.248 196.829 104.822 197.456C100.99 198.445 97.2528 199.797 93.5705 201.236C84.8403 204.654 76.3418 208.671 67.9347 212.817C51.5168 220.912 35.2971 229.352 21.1471 241.108C12.7918 248.051 4.3878 256.274 0.165973 266.476C-0.620476 268.384 1.55597 269.851 3.16849 268.84C17.224 260.057 30.9106 250.714 44.7893 241.656C57.7109 233.223 70.733 224.321 85.1086 218.526C91.4794 215.96 98.0271 213.851 104.505 211.566C101.444 219.494 100.042 227.869 102.38 236.449C102.877 238.272 103.541 240.034 104.331 241.748C105.017 243.236 107.343 243.51 108.001 241.808C113.244 228.323 121.529 216.505 130.689 205.418C130.744 205.397 130.799 205.372 130.857 205.342C134.509 203.498 138.721 203.19 142.745 203.011C147.64 202.791 152.545 202.928 157.437 202.645C167.805 202.046 177.34 198.375 186.17 193.052C186.179 193.052 186.186 193.043 186.192 193.04C182.208 199.955 178.629 207.153 174.992 214.262C174.889 214.308 174.788 214.36 174.688 214.423C148.531 229.187 121.371 242.323 96.6066 259.427C84.4532 267.824 72.8973 277.195 62.8441 288.041C53.8792 297.714 47.5206 309.385 43.1707 321.775C38.2539 335.796 35.6415 350.481 32.7853 365.019C32.4012 366.961 35.1538 368.09 36.3061 366.526C44.2833 355.706 56.8177 349.963 66.88 341.433C77.2471 332.634 85.2519 321.239 93.6467 310.654C102.017 300.112 110.257 289.451 118.737 278.993C127.321 268.414 136.392 258.35 146.833 249.557C152.64 244.663 158.632 239.781 163.336 233.771C165.137 231.467 166.756 228.965 168.466 226.549C165.741 231.391 162.967 236.093 160.827 241.233C158.699 246.346 156.931 251.596 154.944 256.761C151.695 265.21 145.592 272.234 142.525 280.74C142.108 281.894 141.757 283.078 141.516 284.28C141.059 284.992 140.623 285.713 140.206 286.444C130.716 293.434 119.859 297.969 109.894 304.22C99.1793 310.94 90.5436 320.451 82.9108 330.431C75.726 339.823 69.9008 350.228 66.8069 361.684C65.2888 367.305 64.792 372.987 64.1518 378.748C63.53 384.303 62.7801 389.845 62.2284 395.408C61.5669 402.055 61.1249 408.766 61.4937 415.443C61.8169 421.338 62.7923 427.407 65.4748 432.727C66.0844 433.935 67.9804 434.617 68.8857 433.229C74.6744 424.327 78.3933 414.262 82.3225 404.456C84.4258 399.203 86.5595 393.956 89.0134 388.856C91.5434 383.603 94.5399 378.611 97.7253 373.733C104.383 363.531 111.906 353.932 119.057 344.077C122.367 339.515 125.824 334.944 128.436 329.931C130.726 325.54 132.393 320.862 133.844 316.135C136.615 307.106 138.581 297.507 143.184 289.171C143.492 288.939 143.797 288.702 144.101 288.464C144.659 288.251 145.092 287.761 145.153 286.958C145.464 282.782 147.485 278.923 149.494 275.326C151.676 271.424 154.142 267.687 156.212 263.724C158.587 259.168 160.126 254.192 161.909 249.387C163.839 244.188 165.899 239.011 168.609 234.157C171.249 229.428 173.999 224.777 176.513 219.975C179.086 215.063 181.58 210.108 184.155 205.196C187.246 199.304 190.465 193.433 194.099 187.842C194.318 187.687 194.538 187.532 194.757 187.376C193.864 189.516 193.044 191.68 192.291 193.847C187.46 207.761 184.939 222.452 183.759 237.106C182.613 251.334 182.933 265.508 184.479 279.69C186.314 296.554 189.249 313.494 188.252 330.513C187.798 338.283 186.631 346.083 187.182 353.88C187.755 362.031 190.712 369.554 196.242 375.629C197.101 376.575 198.525 376.749 199.394 375.668L199.375 375.665ZM320.687 36.0745C323.863 31.1989 326.96 26.2654 329.438 21.0003C331.185 36.9175 331.749 53.0021 331.106 68.9893C330.953 72.8028 330.725 76.604 330.319 80.3992C330.091 82.5479 329.828 84.6966 329.658 86.8513C324.68 86.0996 319.678 85.2961 314.843 83.887C310.859 82.7274 306.329 81.1601 303.501 77.9492C304.135 76.254 304.763 74.5558 305.406 72.8636C307.506 67.3307 309.698 61.8311 311.953 56.3621C314.761 49.56 317.678 42.7974 320.684 36.0775L320.687 36.0745ZM172.112 195.588C167.387 197.344 162.513 198.354 157.489 198.674C152.755 198.975 148.009 198.862 143.272 199.033C140.727 199.124 138.078 199.261 135.502 199.718C135.636 199.562 135.774 199.404 135.911 199.246C141.559 192.739 147.384 186.387 153.027 179.874C155.84 176.624 158.611 173.334 161.281 169.968C163.973 166.581 166.445 163.026 169.182 159.675C191.185 132.734 225.008 120.746 254.658 104.564C271.192 95.5404 286.997 84.864 298.812 69.9815C299.139 69.5676 299.263 69.1354 299.245 68.7276C299.309 68.7124 299.376 68.7002 299.443 68.688C296.758 75.9771 294.331 83.3635 292.045 90.7865C291.804 91.5656 291.57 92.3447 291.335 93.1239C290.14 95.6925 288.863 98.2277 287.531 100.736C286.507 102.175 285.437 103.584 284.309 104.96C277.706 113.013 269.61 119.419 261.188 125.457C251.174 132.631 241.002 139.585 231.092 146.899C221.329 154.105 211.404 161.577 202.881 170.248C198.388 174.816 194.519 179.847 191.029 185.149C185.097 189.285 178.919 193.068 172.109 195.594L172.112 195.588Z"
            fill="black" fill-opacity="0.04" />
    </svg>

</section>